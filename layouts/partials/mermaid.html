<script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
<script>
  const lightTheme = {
    background: '#fff',
    primaryColor: '#f3f6fa',
    secondaryColor: '#f3f6fa',
    tertiaryColor: '#f3f6fa',
    nodeBkg: '#f3f6fa',
    clusterBkg: '#f3f6fa',
    actorBkg: '#f3f6fa',
    noteBkgColor: '#f3f6fa',
    edgeLabelBackground: '#f3f6fa',
    primaryTextColor: '#24292f',
    fontFamily: 'Segoe UI, PingFang SC, Hiragino Sans GB, Microsoft YaHei, sans-serif',
    fontSize: '16px',
    nodePadding: '12',
    primaryBorderColor: '#b2becd',
    lineColor: '#90a4ae'
  };

  const darkTheme = {
    background: '#23272e',
    primaryColor: '#293042',
    secondaryColor: '#293042',
    tertiaryColor: '#293042',
    nodeBkg: '#293042',
    clusterBkg: '#293042',
    actorBkg: '#293042',
    noteBkgColor: '#293042',
    edgeLabelBackground: '#293042',
    primaryTextColor: '#e9eef6',
    fontFamily: 'Segoe UI, PingFang SC, Hiragino Sans GB, Microsoft YaHei, sans-serif',
    fontSize: '16px',
    nodePadding: '12',
    primaryBorderColor: '#70b3ff',
    lineColor: '#7bb7ff'
  };

  function getMermaidThemeConfig() {
    if (document.body.classList.contains('dark')) {
      return { theme: "dark", themeVariables: darkTheme };
    }
    return { theme: "default", themeVariables: lightTheme };
  }

  function renderAllMermaid() {
    // 1. æ¸…é™¤å·²æ¸²æŸ“çš„å›¾ï¼Œæ¢å¤ä¸ºä»£ç å—
    document.querySelectorAll('div.mermaid').forEach(function(div) {
      if (div.dataset.rawCode) {
        const pre = document.createElement('pre');
        const code = document.createElement('code');
        code.className = 'language-mermaid';
        code.textContent = div.dataset.rawCode;
        pre.appendChild(code);
        div.replaceWith(pre);
      }
    });

    // 2. æŸ¥æ‰¾æ‰€æœ‰ mermaid ä»£ç å—å¹¶æ›¿æ¢ä¸ºæ¸²æŸ“å®¹å™¨
    document.querySelectorAll('code.language-mermaid').forEach(function(block) {
      const pre = block.parentElement;
      const mermaidDiv = document.createElement('div');
      mermaidDiv.className = 'mermaid';
      mermaidDiv.textContent = block.textContent;
      mermaidDiv.dataset.rawCode = block.textContent;
      pre.parentElement.replaceChild(mermaidDiv, pre);
    });

    // 3. æ¸²æŸ“
    mermaid.init();
  }

  function initMermaidWithTheme() {
    const config = Object.assign({ startOnLoad: false }, getMermaidThemeConfig());
    mermaid.initialize(config);
    renderAllMermaid();
  }

  // åˆå§‹åŠ è½½
  document.addEventListener("DOMContentLoaded", initMermaidWithTheme);

  // ä¸»é¢˜åˆ‡æ¢ç›‘å¬
  const observer = new MutationObserver(initMermaidWithTheme);
  observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });

  // ğŸ” é¡µé¢åˆ‡æ¢åé‡æ–°æ¸²æŸ“ï¼ˆå…¼å®¹ InstantClickï¼‰
  document.addEventListener('instantclick:change', initMermaidWithTheme);
</script>
